package com.epam.grandhackathon.deployment.sphere.plugin.metadata.collector;

<<<<<<< HEAD
import com.epam.grandhackathon.deployment.sphere.plugin.TempConstants;
import com.epam.grandhackathon.deployment.sphere.plugin.metadata.model.DeploymentMetaData;
import com.epam.grandhackathon.deployment.sphere.plugin.metadata.persistence.dao.DeploymentMetaDataDao;
import com.epam.grandhackathon.deployment.sphere.plugin.utils.DateFormatUtil;
=======
import static com.google.common.base.Preconditions.checkState;

import javax.inject.Inject;

import org.joda.time.DateTime;

>>>>>>> [Hackatho2015]-added app name auto complete for deploy
import hudson.model.AbstractBuild;
import hudson.model.TaskListener;
import jenkins.model.Jenkins;
import lombok.extern.java.Log;
import org.joda.time.DateTime;

<<<<<<< HEAD
import javax.inject.Inject;
=======
import com.epam.grandhackathon.deployment.sphere.plugin.TempConstants;
import com.epam.grandhackathon.deployment.sphere.plugin.metadata.Constants;
import com.epam.grandhackathon.deployment.sphere.plugin.metadata.model.DeploymentMetaData;
import com.epam.grandhackathon.deployment.sphere.plugin.metadata.persistence.dao.DeploymentMetaDataDao;
import com.epam.grandhackathon.deployment.sphere.plugin.utils.DateFormatUtil;
import com.epam.grandhackathon.deployment.sphere.plugin.utils.EnvVarsResolver;
import com.google.common.base.Strings;
>>>>>>> [Hackatho2015]-added app name auto complete for deploy

@Log
public final class DeployVersionMetaDataCollector implements Collector<DeploymentMetaData> {

    @Inject
    private DeploymentMetaDataDao deploymentMetaDataDao;

    public DeployVersionMetaDataCollector() {
        Jenkins.getInstance().getInjector().injectMembers(this);
    }

    @Override
    public DeploymentMetaData collect(final AbstractBuild<?, ?> build, final TaskListener taskListener) {
        // next variables should be resolved from context
<<<<<<< HEAD
        String buildVersion = "0.0." + (build.getNumber());
        String applicationName = TempConstants.APP_NAME;
=======
        EnvVarsResolver envVarsResolver = new EnvVarsResolver(build, taskListener);

        String buildVersion = envVarsResolver.getValue(Constants.BUILD_VERSION);
        checkState(!Strings.isNullOrEmpty(buildVersion), String.format("Invalid build version", buildVersion));

        String applicationName = envVarsResolver.getValue(Constants.BUILD_APP_NAME);
        checkState(!Strings.isNullOrEmpty(applicationName), String.format("Invalid application name", applicationName));
        
        String envName = envVarsResolver.getValue(Constants.ENV_NAME);
        checkState(!Strings.isNullOrEmpty(envName), String.format("Invalid env name", envName));
>>>>>>> [Hackatho2015]-added app name auto complete for deploy

        // persist data
        DeploymentMetaData deploymentMetaData = new DeploymentMetaData();
        deploymentMetaData.setApplicationName(applicationName);
        deploymentMetaData.setDeployedAt(DateFormatUtil.formatDate(new DateTime(build.due())));
        deploymentMetaData.setBuildVersion(buildVersion);
        deploymentMetaData.setEnvironmentKey("2");
        deploymentMetaDataDao.save(deploymentMetaData);
        return deploymentMetaData;
    }

}
